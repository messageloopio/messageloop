version: '3'

vars:
  Version: v0.1.0
  Comment: "release v0.1.0: init release"

tasks:
  init:
    dir: '{{.USER_WORKING_DIR}}'
    cmds:
      - go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
      - go install github.com/bufbuild/buf/cmd/buf@v1.63.0

  # 重新生成 protobuf
  generate-protocol:
    dir: '{{.USER_WORKING_DIR}}'
    cmds:
      - buf generate

  # 更新依赖
  upgrade-lynx:
    dir: '{{.USER_WORKING_DIR}}'
    cmds:
      - go get -u github.com/lynx-go/x
      - go get -u github.com/lynx-go/lynx
      - go get -u github.com/lynx-go/lynx/contrib/zap
      - go get -u github.com/lynx-go/lynx/contrib/pubsub
      - go get -u github.com/lynx-go/lynx/contrib/kafka
      - go get -u github.com/lynx-go/lynx/contrib/schedule
      - go mod tidy

  release-tag:
    dir: '{{.USER_WORKING_DIR}}'
    cmds:
      - git tag -a {{ .Version }} -m "{{ .Comment }}"
      - git push origin {{ .Version }}

  release-all:
    cmds:
      - task: release-tag
        vars:
          Version: "{{.Version}}"
          Comment: "{{.Comment}}"
      - task: release-tag
        vars:
          Version: "shared/{{.Version}}"
          Comment: "{{.Comment}}"
      - task: release-tag
        vars:
          Version: "sdks/go/{{.Version}}"
          Comment: "{{.Comment}}"
